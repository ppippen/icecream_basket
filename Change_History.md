# Change History / 变更历史

[English](#english) | [中文](#中文)

---

<a name="english"></a>
## English

### 2025-07-11

#### Enhancement: Responsive Layout and Performance Tuning

Performed a series of updates to improve the application's performance and fix critical layout issues on various mobile devices, especially in landscape orientation.

**Key Changes:**

1.  **Audio Preloading for Performance**:
    *   To prevent interaction delays (INP) on the first click, `<link rel="preload">` tags were added to `index.html` for `checkout.mp3`, `newOrder.mp3`, and `undo.mp3`. This ensures sounds are loaded with the page and play instantly.

2.  **Fix for Build Script**:
    *   The `build` script in `package.json` was updated to correctly copy the `sounds/` directory to the `dist/` folder, ensuring audio files are available in the production build.

3.  **Responsive Layout Enhancements**:
    *   **Sticky Action Buttons**: Applied flexbox properties (`justify-content: space-between`) to the `.order-section` to ensure the "Undo" and "Checkout" buttons stick to the bottom of the screen on tablets (e.g., iPad portrait) and mobile landscape views.
    *   **Scrollable Checkout Modal**: Made the checkout modal scrollable on short, wide screens (e.g., iPhone landscape) by setting a `max-height` and `overflow-y: auto`, preventing content from being cut off.
    *   **Corrected Landscape Breakpoint**: Adjusted the CSS media query breakpoint from `700px` to `900px` to correctly apply landscape optimizations to modern, wide-screen phones like the iPhone XR.
    *   **Fixed Cone Sizing**: Corrected an invalid CSS selector (`.cone` to `.stack-item.cone-style`) in the landscape media query to ensure the ice cream cone resizes correctly.

**Files Modified:**

*   `index.html`: Added `<link rel="preload">` tags.
*   `package.json`: Updated the `build` script.
*   `styles.css`: Implemented all responsive layout fixes and enhancements.

### 2025-07-10

#### Feature: Add Sound Effects to UI Buttons

Added sound effects to major button-click events to enhance user interaction and provide auditory feedback.

**Key Changes:**

1.  **Audio Initialization**:
    *   Pre-loaded and decoded `pop.mp3` using the Web Audio API at the start of `script.js` for instant playback.
    *   Created standard `<audio>` elements for the other three sound effects: `undo.mp3`, `checkout.mp3`, and `newOrder.mp3`.
2.  **Encapsulated Playback Functions**:
    *   Created a dedicated function, `playPopSound()`, to play random segments of `pop.mp3`, providing varied sound feedback for adding items. The configuration for the sound clips is:
        ```json
        [
          {"start": 0.11, "duration": 0.02},
          {"start": 0.81, "duration": 0.03},
          {"start": 1.57, "duration": 0.02},
          {"start": 2.08, "duration": 0.03},
          {"start": 2.82, "duration": 0.01}
        ]
        ```
    *   Created three other simple playback functions for `undo.mp3`, `checkout.mp3`, and `newOrder.mp3`.
3.  **Event Binding**:
    *   **Add Item**: Called `playPopSound()` within the `addItemToOrder` function.
    *   **Undo Button**: Invoked the playback function for `undo.mp3` in the undo button's click listener.
    *   **Checkout Button**: Invoked the playback function for `checkout.mp3` in the checkout button's click listener.
    *   **New Order Button**: Invoked the playback function for `newOrder.mp3` in the new order button's click listener.

**Files Modified:**

*   `script.js`: Implemented all logic for loading, playing, and binding sound effects.

### 2025-07-08

#### Feature: Implement scrollable ice cream stack

Implemented a scrollable container for the ice cream and cone, allowing for an unlimited number of scoops to be added without breaking the layout.

**Key Changes:**

-   The ice cream cone is now dynamically generated by JavaScript as the base element of the stack.
-   The ice cream and cone now scroll together as a single unit.
-   The cone correctly appears on top of the ice cream scoops.
-   The view automatically scrolls to the bottom when a new item is added.

**Files Modified:**

-   `index.html`: Removed the static cone element.
-   `styles.css`: Reworked the styles for `.cone-container`, `.ice-cream-stack`, and added a new style for the dynamically created cone (`.cone-style`).
-   `script.js`:
    -   Added logic to initialize the cone on page load.
    -   Modified `updateOrderDisplay` to handle the new stacking logic.
    -   Added auto-scrolling functionality.

#### Enhancement: Adjust Checkout Modal Position

Adjusted the vertical position of the checkout modal to ensure the "Start New Order" button is always visible without scrolling.

**Key Changes:**

-   The `margin-top` of the `.modal-content` was reduced.

**Files Modified:**

-   `styles.css`: Modified the `margin` property for `.modal-content`.

#### Enhancement: Dynamic Test Port Configuration

Configured Playwright to dynamically select an available port for the local test server, resolving port conflict issues.

**Key Changes:**

-   Playwright's `webServer` now automatically selects a free port.
-   Test navigation uses relative paths.

**Files Modified:**

-   `playwright.config.js`: Removed fixed `port` and adjusted `command` for `webServer`.
-   `tests/icecream.spec.js`: Changed `page.goto` to use a relative path (`/`).

#### Refactor: Update Playwright Tests for Dynamic Cone

Rewrote existing Playwright test cases to account for the dynamically added cone element in the ice cream stack, ensuring accurate assertions.

**Key Changes:**

-   Updated assertions for `stack-item` counts to include the cone element.
-   Specifically re-evaluated test cases related to adding items and checking stack contents.

**Files Modified:**

-   `tests/icecream.spec.js`: Modified test cases 2, 3, 5, and 6 to reflect the new DOM structure.

---

<a name="中文"></a>
## 中文

### 2025年7月11日

#### 优化：响应式布局与性能调优

进行了一系列更新，以提升应用性能并修复在多种移动设备（尤其是在横屏模式下）的关键布局问题。

**主要变更：**

1.  **音频预加载以优化性能**:
    *   为了防止首次点击按钮时出现交互延迟（INP），在 `index.html` 中为 `checkout.mp3`, `newOrder.mp3`, 和 `undo.mp3` 添加了 `<link rel="preload">` 标签。这确保了音效文件随页面一同加载，从而实现即时播放。

2.  **修复构建脚本**:
    *   更新了 `package.json` 中的 `build` 脚本，以确保 `sounds/` 目录能被正确复制到 `dist/` 文件夹中，使音效文件在生产版本中可用。

3.  **响应式布局增强**:
    *   **操作按钮贴底**: 对 `.order-section` 应用了 Flexbox 属性 (`justify-content: space-between`)，以确保“撤销”和“结算”按钮在平板电脑（如 iPad 竖屏）和手机横屏视图中能固定在屏幕底部。
    *   **可滚动的结算弹窗**: 通过设置 `max-height` 和 `overflow-y: auto`，使结算弹窗在较矮的宽屏（如 iPhone 横屏）上可以滚动，防止内容被截断。
    *   **修正横屏断点**: 将 CSS 媒体查询的断点从 `700px` 调整为 `900px`，以确保横屏优化能正确应用于像 iPhone XR 这样的现代宽屏手机。
    *   **修复甜筒尺寸**: 在横屏媒体查询中，修正了一个无效的 CSS 选择器（从 `.cone` 改为 `.stack-item.cone-style`），以确保冰激凌甜筒能正确地调整大小。

**修改的文件：**

*   `index.html`: 添加了 `<link rel="preload">` 标签。
*   `package.json`: 更新了 `build` 脚本。
*   `styles.css`: 实现了所有响应式布局的修复与增强。

### 2025年7月10日

#### 功能：为界面按钮添加音效

为了增强用户交互的趣味性和反馈感，为应用内的主要按钮点击事件添加了声音效果。

**主要变更：**

1.  **音频初始化**:
    *   在 `script.js` 开头，使用 Web Audio API 预加载并解码 `pop.mp3` 文件，以实现快速、无延迟的播放。
    *   为 `undo.mp3`、`checkout.mp3` 和 `newOrder.mp3` 创建了常规的 `<audio>` 元素用于播放。
2.  **封装播放函数**:
    *   创建了一个专门的函数 `playPopSound()`，用于从一个预设片段列表中随机播放 `pop.mp3` 的一部分，为添加商品的操作提供多样化的音效。音效片段配置如下：
        ```json
        [
          {"start": 0.11, "duration": 0.02},
          {"start": 0.81, "duration": 0.03},
          {"start": 1.57, "duration": 0.02},
          {"start": 2.08, "duration": 0.03},
          {"start": 2.82, "duration": 0.01}
        ]
        ```
    *   为另外三个音效创建了独立的、简单的播放函数。
3.  **事件绑定**:
    *   **添加商品**: 在 `addItemToOrder` 函数中调用 `playPopSound()`。
    *   **撤销按钮**: 在撤销按钮的点击事件监听器中调用 `undo.mp3` 的播放函数。
    *   **结算按钮**: 在结算按钮的点击事件监听器中调用 `checkout.mp3` 的播放函数。
    *   **新订单按钮**: 在新订单按钮的点击事件监听器中调用 `newOrder.mp3` 的播放函数。

**修改的文件**:

*   `script.js`: 实现了所有音效的加载、播放和事件绑定逻辑。

### 2025年7月8日

#### 功能：实现可滚动的冰激凌堆叠

为冰激凌和甜筒实现了一个可滚动的容器，允许无限添加冰激凌球而不会破坏页面布局。

**主要变更：**

-   甜筒现在由 JavaScript 动态生成，作为堆叠的基础元素。
-   冰激凌和甜筒现在作为一个整体一起滚动。
-   甜筒能够正确地显示在冰激凌球的上方。
-   添加新项目时，视图会自动滚动到底部。

**修改的文件：**

-   `index.html`: 移除了静态的甜筒元素。
-   `styles.css`: 重构了 `.cone-container` 和 `.ice-cream-stack` 的样式，并为动态创建的甜筒（`.cone-style`）添加了新样式。
-   `script.js`:
    -   添加了在页面加载时初始化甜筒的逻辑。
    -   修改了 `updateOrderDisplay` 以处理新的堆叠逻辑。
    -   添加了自动滚动功能。

#### 优化：调整结算模态框位置

调整了结算模态框的垂直位置，以确保“开始新订单”按钮始终可见，无需滚动页面。

**主要变更：**

-   `.modal-content` 的 `margin-top` 值被减小。

**修改的文件：**

-   `styles.css`: 修改了 `.modal-content` 的 `margin` 属性。

#### 优化：动态测试端口配置

配置 Playwright 动态选择本地测试服务器的可用端口，解决了端口冲突问题。

**主要变更：**

-   Playwright 的 `webServer` 现在会自动选择一个空闲端口。
-   测试导航使用相对路径。

**修改的文件：**

-   `playwright.config.js`: 移除了固定的 `port`，并调整了 `webServer` 的 `command`。
-   `tests/icecream.spec.js`: 将 `page.goto` 改为使用相对路径 (`/`)。

#### 重构：更新 Playwright 测试以适应动态甜筒

重写了现有的 Playwright 测试用例，以适应冰激凌堆叠中动态添加的甜筒元素，确保断言的准确性。

**主要变更：**

-   更新了 `stack-item` 数量的断言，以包含甜筒元素。
-   特别重新评估了与添加项目和检查堆叠内容相关的测试用例。

**修改的文件：**

-   `tests/icecream.spec.js`: 修改了测试用例 2、3、5 和 6，以反映新的 DOM 结构。
